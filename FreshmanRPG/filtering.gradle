// Define a task named "checkForDuplicateClasses"
tasks.register('checkForDuplicateClasses') {
    doLast {
        // Define a multimap to store classes with their package names and the subprojects that contain them
        def duplicates = new MyMultimap()

        // For each subproject
        subprojects { Project subproject ->
            // For each source set in the subproject
            subproject.sourceSets.each { SourceSet sourceSet ->
                // Get the directory containing the compiled class files
                def dir = sourceSet.java.classesDirectory.get()

                // If the directory is the main directory
                if (dir.asFile.name.endsWith('main')) {
                    // For each class file in the directory and its subdirectories
                    dir.asFile.eachFileRecurse { File classFile ->
                        // If the file is a class file
                        if (classFile.isFile() && classFile.name.endsWith('.class')) {
                            // Get the name of the class
                            def className = classFile.name.substring(0, classFile.name.indexOf(".class"))
                            // Get the package name of the class
                            def packagePath = classFile.parentFile.absolutePath
                                    .replace(dir.asFile.absolutePath, '')
                                    .replaceAll('[\\\\/]', '.')
                                    .substring(1)

                            // Add the class and its subproject to the multimap
                            duplicates.put(className + ":" + packagePath, subproject)
                        }
                    }
                }
            }
        }

        def outLines = []

        // For each class in the multimap
        def found = duplicates.search(outLines)

        // If duplicates were found, throw a runtime exception with the output
        if (found) {
            throw new RuntimeException(outLines.join('\n'))
        }
    }
}

// Define a class named "MyMultimap"
class MyMultimap {

    // Define an instance variable "map" that is a new empty Map
    Map map = [:]

    // Define a method named "put" that takes a "key" and a "value" as arguments
    boolean put(String key, Project value) {
        // Get the current value for the given key in the map, or an empty list if the key is not present
        List list = map.get(key, []) as List

        // If the list does not already contain the value, add it to the list
        if (!list.contains(value)) {
            list.add(value)
        }

        // Update the map with the new list for the given key
        map."$key" = list
    }

    boolean search(List<String> outLines) {
        def found = false

        map.each { String key, List<Project> value ->
            // If there is more than one subproject that contains the class
            if (value.size() > 1) {
                // Get the class name and package name from the key
                def (name, packageName) = key.tokenize(':')

                // Add information about the duplicate class to the output
                outLines << "Duplicate class found!!"
                outLines << " - Name: $name"
                outLines << " - Package: $packageName"
                outLines << " - Projects: "

                // Add the names of the subprojects containing the class to the output
                value.each { subproject ->
                    outLines << "   - $subproject.name"
                }

                outLines << ""

                // Set found to true
                found = true
            }
        }
    }
}